<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MedQuery Chat Workspace</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0f172a;
        --panel: #111827;
        --panel-2: #1f2937;
        --panel-3: #0b1220;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --accent: #38bdf8;
        --accent-2: #0ea5e9;
        --success: #22c55e;
        --border: #334155;
        --error: #ef4444;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", "Segoe UI", system-ui, sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        padding: 20px 32px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(135deg, #0f172a 0%, #111827 100%);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
      }

      header h1 {
        margin: 0;
        font-size: 22px;
        font-weight: 600;
      }

      header p {
        margin: 6px 0 0;
        color: var(--muted);
        font-size: 13px;
      }

      .profile-menu {
        position: relative;
      }

      .profile-button {
        display: flex;
        align-items: center;
        gap: 10px;
        background: var(--panel-2);
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 6px 12px;
        color: var(--text);
        cursor: pointer;
      }

      .avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(56, 189, 248, 0.3);
        display: grid;
        place-items: center;
        font-weight: 600;
        color: var(--accent);
      }

      .dropdown {
        position: absolute;
        right: 0;
        top: 48px;
        min-width: 220px;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.45);
        padding: 8px;
        display: none;
        z-index: 10;
      }

      .dropdown.open {
        display: grid;
        gap: 4px;
      }

      .dropdown a,
      .dropdown button {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: none;
        background: transparent;
        color: var(--text);
        text-decoration: none;
        font-size: 13px;
        cursor: pointer;
      }

      .dropdown a:hover,
      .dropdown button:hover {
        background: rgba(56, 189, 248, 0.12);
      }

      main {
        flex: 1;
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 24px;
        padding: 24px 32px 40px;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.35);
      }

      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .sidebar h2 {
        margin: 0;
        font-size: 16px;
      }

      .sidebar button {
        width: 100%;
        border: none;
        border-radius: 12px;
        padding: 12px 16px;
        background: var(--accent);
        color: #0f172a;
        font-weight: 600;
        cursor: pointer;
      }

      .chat-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 360px;
        overflow-y: auto;
      }

      .chat-list li {
        padding: 12px;
        border-radius: 12px;
        background: var(--panel-2);
        border: 1px solid transparent;
        cursor: pointer;
        font-size: 13px;
      }

      .chat-list li.active {
        border-color: rgba(56, 189, 248, 0.6);
        background: rgba(56, 189, 248, 0.08);
        color: var(--text);
      }

      .chat-meta {
        color: var(--muted);
        font-size: 11px;
        margin-top: 6px;
      }

      .content {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }

      label {
        display: block;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: var(--muted);
        margin-bottom: 6px;
      }

      input,
      textarea,
      select {
        width: 100%;
        box-sizing: border-box;
        border-radius: 10px;
        border: 1px solid var(--border);
        padding: 10px 12px;
        background: var(--panel-2);
        color: var(--text);
        font-size: 14px;
      }

      textarea {
        min-height: 80px;
        resize: vertical;
      }

      .messages {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding-right: 6px;
      }

      .message {
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--panel-2);
        max-width: 85%;
      }

      .message.user {
        align-self: flex-end;
        background: rgba(56, 189, 248, 0.15);
        border-left: 4px solid var(--accent);
      }

      .message.assistant {
        border-left: 4px solid #a78bfa;
      }

      .message.system {
        border-left: 4px solid var(--error);
        background: rgba(239, 68, 68, 0.1);
      }

      .message .meta {
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 6px;
      }

      .composer {
        display: flex;
        gap: 12px;
        align-items: flex-end;
      }

      .composer textarea {
        flex: 1;
      }

      .composer button {
        border: none;
        border-radius: 12px;
        padding: 12px 16px;
        background: var(--accent);
        color: #0f172a;
        font-weight: 600;
        cursor: pointer;
      }

      .secondary-btn {
        flex-shrink: 0;
        border: 1px solid var(--accent);
        border-radius: 10px;
        padding: 10px 14px;
        background: transparent;
        color: var(--accent);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
      }

      .secondary-btn:hover {
        background: rgba(56, 189, 248, 0.15);
      }

      .status {
        font-size: 12px;
        color: var(--muted);
      }

      .status.error {
        color: var(--error);
      }

      .status.success {
        color: var(--success);
      }

      @media (max-width: 1024px) {
        main {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <h1>Chat Workspace</h1>
        <p>Manage your chat sessions and prompts from a dedicated interface.</p>
      </div>
      <div class="profile-menu">
        <button class="profile-button" id="profile-toggle" type="button">
          <span class="avatar" id="profile-avatar">A</span>
          <span id="profile-name">Admin</span>
        </button>
        <div class="dropdown" id="profile-dropdown">
          <a href="/profile">Profile</a>
          <a href="/rag-builder">RAG builder</a>
          <a href="/database-overview">Database overview</a>
          <a href="/assignments">Assignments</a>
          <a href="/system-config">System configurations</a>
          <a href="/system-logs">System logs</a>
          <button type="button" id="logout">Sign out</button>
        </div>
      </div>
    </header>

    <main>
      <aside class="sidebar panel">
        <h2>Chats</h2>
        <button id="new-chat" type="button">+ New chat</button>
        <ul class="chat-list" id="chat-list"></ul>
        <div class="status" id="chat-status">Select a chat to begin.</div>
      </aside>

      <section class="content">
        <div class="panel">
          <h2>Chat Settings</h2>
          <div class="settings-grid">
            <div>
              <label for="business">Business Client ID</label>
              <input id="business" />
            </div>
            <div>
              <label for="workspace">Workspace ID</label>
              <input id="workspace" />
            </div>
            <div>
              <label for="user">User ID</label>
              <input id="user" placeholder="u123" />
            </div>
            <div>
              <label for="temperature">Temperature</label>
              <input id="temperature" type="number" step="0.1" min="0" max="2" value="0.2" />
            </div>
            <div>
              <label for="max-tokens">Max Tokens</label>
              <input id="max-tokens" type="number" min="1" value="600" />
            </div>
            <div>
              <label for="mode">Mode</label>
              <select id="mode">
                <option value="chat">Chat</option>
                <option value="retrieve">Retrieve</option>
              </select>
            </div>
          </div>
          <div style="margin-top: 12px;">
            <label for="prompt">Prompt Engineering (per workspace)</label>
            <div style="display: flex; gap: 8px; align-items: flex-start;">
              <textarea id="prompt" style="flex: 1;">You are a medical assistant. Provide concise answers.</textarea>
              <button type="button" id="save-prompt" class="secondary-btn">Save to workspace</button>
            </div>
            <div class="status" id="prompt-status" style="margin-top: 6px;">Prompt is loaded per workspace. Edit and click Save to persist.</div>
          </div>
          <div style="margin-top: 12px;">
            <label for="chat-override">Chat Config Override (JSON)</label>
            <textarea id="chat-override" placeholder='{"model":"gpt-4.1-mini"}'></textarea>
            <div class="status">Overrides are merged into chat_config_override when sending.</div>
          </div>
        </div>

        <div class="panel" style="display: flex; flex-direction: column; gap: 16px; flex: 1;">
          <div>
            <h2 id="active-chat-title">Conversation</h2>
            <div class="status" id="session-status">Ready.</div>
          </div>
          <div class="messages" id="messages"></div>
          <div class="composer">
            <textarea id="input" placeholder="Type a prompt..."></textarea>
            <button id="send" type="button">Send</button>
          </div>
          <div class="status" id="send-status"></div>
        </div>
      </section>
    </main>

    <script>
      const token = localStorage.getItem("adminToken");
      if (!token) {
        window.location.assign("/ui");
      }

      const profileName = document.getElementById("profile-name");
      const profileAvatar = document.getElementById("profile-avatar");
      const profileToggle = document.getElementById("profile-toggle");
      const profileDropdown = document.getElementById("profile-dropdown");
      const logoutButton = document.getElementById("logout");

      const chatListEl = document.getElementById("chat-list");
      const chatStatusEl = document.getElementById("chat-status");
      const messagesEl = document.getElementById("messages");
      const activeChatTitleEl = document.getElementById("active-chat-title");
      const sessionStatusEl = document.getElementById("session-status");
      const sendStatusEl = document.getElementById("send-status");
      const newChatButton = document.getElementById("new-chat");
      const sendButton = document.getElementById("send");
      const inputEl = document.getElementById("input");

      const businessEl = document.getElementById("business");
      const workspaceEl = document.getElementById("workspace");
      const userEl = document.getElementById("user");
      const temperatureEl = document.getElementById("temperature");
      const maxTokensEl = document.getElementById("max-tokens");
      const promptEl = document.getElementById("prompt");
      const overrideEl = document.getElementById("chat-override");
      const modeEl = document.getElementById("mode");

      const buildHeaders = () => {
        const h = { "Content-Type": "application/json" };
        if (token) h.Authorization = `Bearer ${token}`;
        return h;
      };

      const setStatus = (node, message, type = "") => {
        if (!node) return;
        node.textContent = message;
        node.classList.remove("error", "success");
        if (type) node.classList.add(type);
      };

      const defaults = JSON.parse(localStorage.getItem("chatDefaults") || "{}");
      const preferences = JSON.parse(localStorage.getItem("chatPreferences") || "{}");
      businessEl.value = defaults.businessClientId || localStorage.getItem("adminBusinessId") || "default";
      workspaceEl.value = defaults.workspaceId || "main";
      userEl.value = defaults.userId || "u123";
      temperatureEl.value = preferences.temperature ?? 0.2;
      maxTokensEl.value = preferences.maxTokens ?? 600;

      const promptStatusEl = document.getElementById("prompt-status");
      const savePromptBtn = document.getElementById("save-prompt");

      const loadWorkspacePrompt = async () => {
        const b = businessEl.value.trim();
        const w = workspaceEl.value.trim();
        if (!b || !w) return;
        setStatus(promptStatusEl, "Loading prompt...");
        try {
          const res = await fetch(`/api/admin/businesses/${encodeURIComponent(b)}/workspaces/${encodeURIComponent(w)}/config`, { headers: buildHeaders() });
          if (!res.ok) {
            setStatus(promptStatusEl, "Could not load workspace config.", "error");
            promptEl.value = preferences.promptEngineering || "You are a medical assistant. Provide concise answers.";
            return;
          }
          const cfg = await res.json();
          const stored = cfg?.prompt_engineering;
          promptEl.value = typeof stored === "string" ? stored : (preferences.promptEngineering || "You are a medical assistant. Provide concise answers.");
          setStatus(promptStatusEl, "Prompt loaded from workspace.", "success");
        } catch (e) {
          setStatus(promptStatusEl, "Could not load prompt: " + (e?.message || "Request failed"), "error");
          promptEl.value = preferences.promptEngineering || "You are a medical assistant. Provide concise answers.";
        }
      };

      const saveWorkspacePrompt = async () => {
        const b = businessEl.value.trim();
        const w = workspaceEl.value.trim();
        if (!b || !w) {
          setStatus(promptStatusEl, "Set Business and Workspace first.", "error");
          return;
        }
        try {
          const res = await fetch(`/api/admin/businesses/${encodeURIComponent(b)}/workspaces/${encodeURIComponent(w)}/config`, {
            method: "GET",
            headers: buildHeaders(),
          });
          if (!res.ok) {
            setStatus(promptStatusEl, "Could not load workspace config.", "error");
            return;
          }
          const cfg = await res.json();
          const updated = { ...cfg, prompt_engineering: promptEl.value.trim() };
          const putRes = await fetch(`/api/admin/businesses/${encodeURIComponent(b)}/workspaces/${encodeURIComponent(w)}/config`, {
            method: "PUT",
            headers: buildHeaders(),
            body: JSON.stringify(updated),
          });
          if (!putRes.ok) {
            const err = await putRes.json().catch(() => ({}));
            setStatus(promptStatusEl, "Failed to save: " + (err.detail || putRes.statusText), "error");
            return;
          }
          setStatus(promptStatusEl, "Prompt saved to workspace.", "success");
          logEvent("info", "chat", "prompt_saved_to_workspace", `${b}/${w}`);
        } catch (e) {
          setStatus(promptStatusEl, "Error: " + (e.message || "Request failed"), "error");
        }
      };

      businessEl.addEventListener("change", loadWorkspacePrompt);
      workspaceEl.addEventListener("change", loadWorkspacePrompt);
      savePromptBtn.addEventListener("click", saveWorkspacePrompt);

      loadWorkspacePrompt();

      const email = localStorage.getItem("adminEmail") || "Admin";
      profileName.textContent = email;
      profileAvatar.textContent = email.charAt(0).toUpperCase();

      const storageKey = "medqueryChats";
      const loadChats = () => JSON.parse(localStorage.getItem(storageKey) || "[]");
      const saveChats = (chats) => localStorage.setItem(storageKey, JSON.stringify(chats));

      let chats = loadChats();
      let activeChatId = chats[0]?.id || null;

      const logEvent = (level, tag, action, details = "") => {
        const logStorageKey = "systemLogs";
        const logs = JSON.parse(localStorage.getItem(logStorageKey) || "[]");
        logs.unshift({
          id: crypto.randomUUID(),
          timestamp: new Date().toISOString(),
          level,
          tag,
          action,
          details,
        });
        localStorage.setItem(logStorageKey, JSON.stringify(logs.slice(0, 500)));
      };

      const renderChats = () => {
        if (!chats.length) {
          chatListEl.innerHTML = "";
          chatStatusEl.textContent = "No chats yet. Start a new conversation.";
          return;
        }

        chatStatusEl.textContent = "";
        chatListEl.innerHTML = chats
          .map((chat) => {
            const lastMessage = chat.messages[chat.messages.length - 1];
            return `
              <li data-id="${chat.id}" class="${chat.id === activeChatId ? "active" : ""}">
                <div>${chat.title}</div>
                <div class="chat-meta">${lastMessage ? lastMessage.content.slice(0, 50) : "No messages yet"}</div>
              </li>
            `;
          })
          .join("");

        chatListEl.querySelectorAll("li[data-id]").forEach((item) => {
          item.addEventListener("click", () => {
            activeChatId = item.dataset.id;
            renderChats();
            renderMessages();
          });
        });
      };

      const renderMessages = () => {
        const chat = chats.find((entry) => entry.id === activeChatId);
        if (!chat) {
          messagesEl.innerHTML = "";
          activeChatTitleEl.textContent = "Conversation";
          return;
        }
        activeChatTitleEl.textContent = chat.title;
        messagesEl.innerHTML = chat.messages
          .map(
            (message) => `
              <div class="message ${message.role}">
                <div class="meta">${message.role.toUpperCase()}</div>
                <div>${message.content}</div>
              </div>
            `
          )
          .join("");
        messagesEl.scrollTop = messagesEl.scrollHeight;
      };

      const createChat = () => {
        const newChat = {
          id: crypto.randomUUID(),
          title: "New chat",
          messages: [],
        };
        chats = [newChat, ...chats];
        activeChatId = newChat.id;
        saveChats(chats);
        renderChats();
        renderMessages();
        logEvent("info", "chat", "chat_created", newChat.id);
      };

      const appendMessage = (role, content) => {
        const chat = chats.find((entry) => entry.id === activeChatId);
        if (!chat) {
          return;
        }
        chat.messages.push({ role, content, timestamp: new Date().toISOString() });
        if (chat.title === "New chat" && role === "user") {
          chat.title = content.split(" ").slice(0, 4).join(" ") || "Conversation";
        }
        saveChats(chats);
        renderChats();
        renderMessages();
      };

      const buildPayload = (query) => {
        const basePayload = {
          business_client_id: businessEl.value.trim(),
          workspace_id: workspaceEl.value.trim(),
          user_id: userEl.value.trim(),
          query,
        };

        if (modeEl.value === "retrieve") {
          return {
            ...basePayload,
            top_k: 5,
          };
        }

        let override = {};
        const overrideText = overrideEl.value.trim();
        if (overrideText) {
          try {
            override = JSON.parse(overrideText);
          } catch (error) {
            throw new Error("Chat config override must be valid JSON.");
          }
        }

        return {
          ...basePayload,
          prompt_engineering: promptEl.value.trim(),
          chat_config_override: {
            temperature: parseFloat(temperatureEl.value || "0.2"),
            max_tokens: parseInt(maxTokensEl.value || "600", 10),
            ...override,
          },
        };
      };

      const formatChatResponse = (responseBody) => {
        const parts = [responseBody.answer];
        if (responseBody.sources && responseBody.sources.length > 0) {
          parts.push("\n---\nSources (" + responseBody.sources.length + "):");
          responseBody.sources.forEach((s, i) => {
            parts.push(`  ${i + 1}. ${s.filename}${s.page != null ? ` (page ${s.page})` : ""}`);
          });
        }
        if (responseBody.usage) {
          const u = responseBody.usage;
          parts.push("\n---\nTokens: " + (u.prompt_tokens || 0) + " prompt, " + (u.completion_tokens || 0) + " completion" + (u.total_tokens ? " (" + u.total_tokens + " total)" : ""));
        }
        return parts.join("\n");
      };

      const sendMessage = async () => {
        const query = inputEl.value.trim();
        if (!query) {
          setStatus(sendStatusEl, "Type a prompt before sending.", "error");
          logEvent("warning", "chat", "chat_send_validation", "Empty prompt");
          return;
        }

        const isChatMode = modeEl.value === "chat";
        if (isChatMode) {
          if (!businessEl.value.trim() || !workspaceEl.value.trim()) {
            setStatus(sendStatusEl, "Set Business and Workspace for RAG chat.", "error");
            return;
          }
          // Prompt optional: API uses workspace config when not provided
        }

        if (!activeChatId) {
          createChat();
        }

        appendMessage("user", query);
        inputEl.value = "";
        setStatus(sessionStatusEl, "Processing...");
        setStatus(sendStatusEl, "Sending request...");
        logEvent("info", "chat", "chat_send", `mode=${modeEl.value}`);

        const endpoint = modeEl.value === "retrieve" ? "/api/rag/retrieve" : "/api/chat/generate";

        try {
          const payload = buildPayload(query);
          const response = await fetch(endpoint, {
            method: "POST",
            headers: buildHeaders(),
            body: JSON.stringify(payload),
          });
          const responseBody = await response.json().catch(() => ({}));
          if (!response.ok) {
            const errMsg = Array.isArray(responseBody.detail) ? responseBody.detail.map(d => d.msg || d.loc?.join(".")).join("; ") : (responseBody.detail && typeof responseBody.detail === "object" ? JSON.stringify(responseBody.detail) : responseBody.detail || "Request failed.");
            throw new Error(errMsg);
          }
          if (isChatMode && responseBody.answer != null) {
            appendMessage("assistant", formatChatResponse(responseBody));
          } else if (modeEl.value === "retrieve" && responseBody.retrieved_chunks != null) {
            const lines = ["Retrieved " + responseBody.retrieved_chunks.length + " chunk(s):"];
            (responseBody.retrieved_chunks || []).forEach((c, i) => {
              lines.push("\n" + (i + 1) + ". " + (c.filename || "?") + (c.page != null ? " (page " + c.page + ")" : "") + " — " + (c.content || "").slice(0, 200) + (c.content && c.content.length > 200 ? "…" : ""));
            });
            appendMessage("assistant", lines.join("\n"));
          } else {
            appendMessage("assistant", JSON.stringify(responseBody, null, 2));
          }
          setStatus(sessionStatusEl, "Response received.", "success");
          setStatus(sendStatusEl, "", "success");
          logEvent("info", "chat", "chat_response_received");
        } catch (error) {
          appendMessage("system", `Error: ${error.message}`);
          setStatus(sessionStatusEl, "Request failed.", "error");
          setStatus(sendStatusEl, error.message, "error");
          logEvent("error", "chat", "chat_request_failed", error.message);
        }
      };

      newChatButton.addEventListener("click", createChat);
      sendButton.addEventListener("click", sendMessage);
      inputEl.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && (event.ctrlKey || event.metaKey)) {
          sendMessage();
        }
      });

      profileToggle.addEventListener("click", () => {
        profileDropdown.classList.toggle("open");
      });

      document.addEventListener("click", (event) => {
        if (!profileToggle.contains(event.target) && !profileDropdown.contains(event.target)) {
          profileDropdown.classList.remove("open");
        }
      });

      logoutButton.addEventListener("click", () => {
        localStorage.removeItem("adminToken");
        localStorage.removeItem("adminBusinessId");
        localStorage.removeItem("adminEmail");
        localStorage.removeItem("adminLoginAt");
        logEvent("info", "auth", "logout");
        window.location.assign("/ui");
      });

      window.addEventListener("error", (event) => {
        logEvent("error", "system", "window_error", event.message || "Unexpected error");
      });

      window.addEventListener("unhandledrejection", (event) => {
        logEvent("error", "system", "unhandled_rejection", event.reason?.message || "Unhandled promise rejection");
      });

      if (!chats.length) {
        createChat();
      } else {
        renderChats();
        renderMessages();
      }
    </script>
  </body>
</html>
